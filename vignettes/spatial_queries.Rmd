---
title: "Spatial Queries"
author: "Zac Driscoll"
date: "12/10/2021"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

---
title: "Spatial Queries"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to arcpullr}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(arcpullr)
library(sf)
```

```{r, echo = FALSE}
#<img src='../man/figures/logo.png' width="160" height="180" style="border: none" align="right"/>
```

## Spatial Queries

ArcGIS REST API's may be spatially queried using the get_layer_by\_\* family of functions.These functions require a spatial object of class sf and a spatial relationship to be passed to the geometry and sp_rel arguments respectively.

The package contains five functions that can be used to perform
spatial queires:

<ul>

<li>

get_layer_by_line

<li>

get_layer_by_point

<li>

get_layer_by_polygon

<li>

get_layer_by_multipoint

<li>

get_layer_by_envelope

</u >


## Spatial Relationship

The "sp_rel" argument can be used to define the spatial relationship
between the two feature classes involved within a spatial query. The
default spatial relationships is xxx.

```{r}
server <- "https://dnrmaps.wi.gov/arcgis2/rest/services/"
layer <- "TS_AGOL_STAGING_SERVICES/EN_AGOL_STAGING_SurfaceWater_WTM/MapServer/2"
river_url <- paste0(server,layer)

brown_county <- wis_counties[wis_counties$county == "brown",]
brown_rivers <-get_layer_by_poly(river_url,brown_county)
plot_layer(brown_rivers)

```

Using "esriSpatialRelCrosses" results in different records being
returned. 
```{r}
brown_rivers <-get_layer_by_poly(river_url,brown_county,sp_rel = "esriSpatialRelCrosses")
plot_layer(brown_rivers)
```


The 'sp_rel_lookup' data.frame explains the various different types of
spatial relationships available through ArcGIS REST APIs.

```{r, echo = FALSE}
sp_rel_lookup %>%
  DT::datatable()
```

The 'sp_rel_valid' data.frame shows which spatial relationships are
valid with different geometry types being queried and used to do spatial
queries.

```{r, echo = FALSE}
sp_rel_lookup %>%
  DT::datatable()

```

The valid_sp_rel function can be used to to see which spatial relation
types are applicable to the feature classes being queried and the sf
objects use do to a spatial query


## get_layer_by_line
The get_layer_by_line function uses A LINSESTRING or MULTILINESTRING sf object to query an ArcGIS REST API. The below example uses the
 a MULTILINESTRING sf object of the Milwaukee River to query the Wisconsin County polygon layer. 
```{r}
#Get the Milwaukee River MULTILINELINESTRING from the 
#Wisconsin Department Natural Resources server. 
mke_river <- get_spatial_layer(river_url, 
                               where = "RIVER_SYS_NAME = 'Milwaukee River'")

#Pass the mke_river sf object to the geometry arguement  to perform
#a spatial query.
server2 <- "https://dnrmaps.wi.gov/arcgis/rest/services/"
layer <- "DW_Map_Dynamic/EN_Basic_Basemap_WTM_Ext_Dynamic_L16/MapServer/3"
county_url <- paste0(server2,layer)
counties <- get_layer_by_line(url = county_url, geometry = mke_river)

#A plot showing the result of the the two queries 
ggplot2::ggplot() + 
  ggplot2::geom_sf(data = counties) +
  ggplot2::geom_sf(data = mke_river,color = "blue")

```

## get_layer_by_point

Spatial queries can be performed using a line.

```{r}
#get trout habitat projects
server <- "https://dnrmaps.wi.gov/arcgis/rest/services/"
layer <- "FM_Trout/FM_TROUT_HAB_SITES_WTM_Ext/MapServer/0"
trout_url <- paste0(server,layer)
trout_projects<- 
  get_spatial_layer(
    trout_url,
    where = "WATERBODYNAMECOMBINED = 'Little Bois Brule'",
    distance = '1000')


#what counties have habitat projects? 
# counties <- get_layer_by_point(url = county_url, geometry = trout_projects)
trout_streams <- get_layer_by_point(url = river_url, 
                                    geometry = trout_projects)


layer <- "WT_SWDV/WT_Inland_Water_Resources_WTM_Ext_v2/MapServer/5"
watershed_url <- paste0(server2,layer)

watershed <- get_layer_by_point(url = watershed_url,
                                geometry = trout_projects)



#plot layers

    ggplot2::ggplot() +
    ggplot2::geom_sf(data = trout_streams, color = "blue")

    
```

## get_layer_by_polygon

Spatial queries can be performed using a line.

```{r}
#get trout habitat projects
brown_rivers <-get_layer_by_poly(river_url,brown_county)
plot_layer(brown_rivers)

```

## Combining Spatial and SQL Queries
SQL statements can be passed to the "where" argument
to further refine queries.

```{r}
brown_rivers <- get_layer_by_poly(river_url,
                                  brown_county,
                                  where = "STREAM_ORDER > 3")

plot_layer(brown_rivers)

```
